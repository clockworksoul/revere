{{template "header.html" "readings"}}
<h1>readings</h1>

<div class="readings">
  <div class="revere-row"><div class="col-md-2">config name</div><div class="col-md-2">subprobe</div><div class="col-md-2">read time</div><div class="col-md-1">state</div><div class="col-md-3">silence time</div><div class="buttons col-md-2"></div></div>
  {{range .Readings}}
    {{if .IsCurrent}}
      {{if eq .State 0}}
        <div class="revere-row bg-success">
      {{else}}
        <div class="revere-row bg-danger">
      {{end}}
    {{else}}
      <div class="revere-row">
    {{end}}
    <div class="col-md-2">{{.ConfigName}}</div><div class="col-md-2">{{.Subprobe}}</div><div class="col-md-2">{{.Time}}</div><div class="col-md-1">{{.State}}</div><div class="datepicker-target col-md-3">{{.SilenceTime}}</div><div class="buttons col-md-2"><button type="button" class="silence-btn btn btn-xs" data-configid="{{.ConfigId}}" data-subprobe="{{.Subprobe}}">Silence</button></div></div>
  {{end}}
</div>


<div style="display: none;">
  {{template "datetimepicker.html"}}
</div>

{{define "MoreScripts"}}
<script type="text/javascript">
  $(document).ready(function(){
    var cancelFunc = function() {
      var $this = $(this);
      var $dp = $this.parent().siblings('.datepicker-target').children('.silence-datepicker');
      if ($dp.length) {
        var $silence = $this.siblings();
        $silence.removeClass('btn-danger');
        $this.fadeOut(function() {
          $this.remove();
        });
        $this.parent().animate({width: 'initial'}, 500);
        $dp.animate({width:'hide'}, 500, function() {
          $(this).remove();
        });
      }
    }
    $('.silence-btn').click(function(){
      var $this = $(this);
      var $dpdiv = $this.parent().siblings('div.datepicker-target');
      if (!$this.hasClass('btn-danger')) {
        var $dp = $('#silence-datepicker').clone();
        $dp.removeAttr('id');
        $dp.datetimepicker({
          useCurrent: false,
          defaultDate: moment().add(1, 'hours'),
          minDate: moment(),
          maxDate: moment().add(14, 'days')
        });
        $dpdiv.html($dp);
        $dp.data('configid', $this.data('configid'))
        $dp.data('subprobe', $this.data('subprobe'))

        var $cancel = $this.clone();
        $this.addClass('btn-danger');
        $cancel.removeClass('silence-btn');
        $cancel.html('Cancel');
        $cancel.click(cancelFunc);
        $cancel.hide();
        $this.after($cancel);
        $cancel.fadeIn();

        $dp.children('.calendar-icon').hide();
        $dp.animate({width:'show'}, 500, function() {
          $dp.css('display', 'table');
          $dp.children('.calendar-icon').show();
        });
      } else {
        var $dp = $dpdiv.children('.silence-datepicker');
        var data = {
          configId: $dp.data('configid'),
          subprobe: $dp.data('subprobe'),
          silenceTime: $dp.data('DateTimePicker').date().utc().format('MM/DD/YYYY h:mm A Z')
        }
        $.ajax('/silence', {
          method: 'POST',
          data: data,
          success: function(d) {
            $this.siblings().click();
            $dpdiv.html($dp.data('DateTimePicker').date().format('MM/DD/YYYY h:mm A'));
          },
          error: function(d) {
          {{/* TODO(dp): make this a better UX */}}
            alert('Error silencing alert\n' + d.status + ": "+d.responseText);
          }
        });
      }
    });
  });
</script>
{{end}}

{{template "footer.html"}}